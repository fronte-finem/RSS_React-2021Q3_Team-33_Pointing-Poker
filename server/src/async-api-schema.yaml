asyncapi: 2.1.0

info:
  title: Pointing Poker
  version: 1.0.0
  description: |
    Приложение для проведения сессий по оценке сложности предстоящей работы или
    относительного объёма решаемых задач при разработке программного обеспечения

servers:
  demo:
    url: localhost
    protocol: wss

channels:
  /:
    publish:
      summary: Набор событий инициируемых клиентом
      message:
        oneOf:
          - $ref: '#/components/messages/CreateGame'
          - $ref: '#/components/messages/JoinGame'
          - $ref: '#/components/messages/AddUser'
          - $ref: '#/components/messages/KickUser'
          - $ref: '#/components/messages/VoteKick'
          - $ref: '#/components/messages/AddChatMessage'
          - $ref: '#/components/messages/AddIssue'
          - $ref: '#/components/messages/StartGame'
          - $ref: '#/components/messages/CancelGame'
          - $ref: '#/components/messages/EndGame'
          - $ref: '#/components/messages/StartRound'
          - $ref: '#/components/messages/AddScore'

    subscribe:
      summary: Набор событий инициируемыех сервером
      message:
        oneOf:
          - $ref: '#/components/messages/UserJoined'
          - $ref: '#/components/messages/UsersList'
          - $ref: '#/components/messages/KickVoteStarted'
          - $ref: '#/components/messages/KickVoteEnded'
          - $ref: '#/components/messages/UserKicked'
          - $ref: '#/components/messages/ChatMessageAdded'
          - $ref: '#/components/messages/MessagesList'
          - $ref: '#/components/messages/IssueAdded'
          - $ref: '#/components/messages/IssuesList'
          - $ref: '#/components/messages/GameStarted'
          - $ref: '#/components/messages/GameCanceled'
          - $ref: '#/components/messages/GameEnded'
          - $ref: '#/components/messages/RoundStarted'
          - $ref: '#/components/messages/RoundEnded'

components:
  schemas:
    User:
      description: Объект пользователя игры (дилер/игрок/набдюдатель)
      type: object
      properties:
        firstName:
          type: string
        lastName:
          type: [string, 'null']
        jobPosition:
          type: [string, 'null']
        avatar:
          type: [string, 'null']
        role:
          type: string
          enum:
            - 'dealer'
            - 'gamer'
            - 'spectator'

    ChatMessage:
      description: Обект сообщения чата
      type: object
      properties:
        user:
          $ref: '#/components/schemas/User'
        message:
          type: string

    Issue:
      description: Обект задачи для оценки в процессе игры
      type: object
      properties:
        title:
          type: string
        priority:
          type: string
          enum:
            - high
            - low

    Score:
      description: Значение игровой карты (число или названи особенной карты)
      type: [number, string]

    UserScore:
      description: Объект оценки поставленной игроком
      type: object
      properties:
        user:
          $ref: '#/components/schemas/User'
        score:
          $ref: '#/components/schemas/Score'

    RoundResult:
      description: Массив оценок выставленных игроками
      type: array
      items:
        $ref: '#/components/schemas/UserScore'

    GameResult:
      description: Массив всех оценённых задач
      type: array
      items:
        type: object
        properties:
          issue:
            $ref: '#/components/schemas/Issue'
          result:
            $ref: '#/components/schemas/RoundResult'

    CardSet:
      description: Тип набора карт - числа Фибоначчи, степени двойки или массив собственной последовательности
      oneOf:
        - type: string
          enum:
            - fibb
            - pow2
        - type: array
          items:
            $ref: '#/components/schemas/Score'

    GameSettings:
      description: Набор настроек игры
      type: object
      properties:
        dealerGamer:
          description: будет ли дилер принимать участие в игре
          type: boolean
        cardsSet:
          description: какой набор карточек будет использоваться
          $ref: '#/components/schemas/CardSet'
        autoJoinToGame:
          description: впускать автоматически всех новых участников, если игра уже началась или впускать через механизм admit/reject
          type: boolean
        autoOpenCards:
          description: будут ли карты переворачиваться автоматически как только все проголосуют
          type: boolean
        changeAfterRoundEnd:
          description: можно ли менять свой выбор после того как все карты уже перевернуты
          type: boolean
        timeout:
          description: конфигурации времени таймера или null если он ненужен
          type: [number, 'null']

  messages:
    CreateGame:
      name: 'create game'
      description: Запрос на создание игры (комнаты в терминологии socket.io)
      x-ack:
        description: ответ сервера в колбеке (в случае успеха - айди игры, иначе описание ошибки)
        args:
          type: object
          properties:
            gameId:
              type: [string, 'null']
            error:
              type: [string, 'null']

    JoinGame:
      name: 'join game'
      description: Запрос на присоединение к игре по айди
      payload:
        description: game-ID
        type: string
      x-ack:
        description: ответ сервера в колбеке (в случае неуспешной валидации - ошибка)
        args:
          type: object
          properties:
            error:
              type: [string, 'null']

    AddUser:
      name: 'add user'
      description: Запрос на создание пользователя
      payload:
        $ref: '#/components/schemas/User'
      x-ack:
        description: ответ сервера после валидации
        args:
          type: object
          properties:
            error:
              type: [string, 'null']

    UserJoined:
      name: 'user joined'
      description: Сообщение от сервера о новом участнике
      payload:
        $ref: '#/components/schemas/User'

    UsersList:
      name: 'users list'
      description: Список ползовотелей отсылаемый сервером после каждого изменения
      payload:
        type: array
        items:
          $ref: '#/components/schemas/User'

    KickUser:
      name: 'kick user'
      description: Запрос на удаление пользователя (в зависимости от роли инициатора запускает голосование или сразу удаляет)
      payload:
        type: object
        properties:
          user:
            $ref: '#/components/schemas/User'

    KickVoteStarted:
      name: 'kick vote started'
      description: Сообщение о старте голосования по удалению участника
      payload:
        type: object
        properties:
          initiator:
            description: user started vote
            $ref: '#/components/schemas/User'
          user:
            description: user requested to be kiked
            $ref: '#/components/schemas/User'

    KickVoteEnded:
      name: 'kick vote ended'
      description: Сообщение о завершении голосования по удалению участника

    VoteKick:
      description: Запрос с голосом по удалению участника
      name: 'vote kick'
      payload:
        type: boolean

    UserKicked:
      name: 'user kicked'
      description: Сообщение об удаленом участнике
      payload:
        type: object
        properties:
          user:
            $ref: '#/components/schemas/User'
          kiked:
            type: boolean

    AddChatMessage:
      name: 'add chat message'
      description: Запрос с сообщением в чат
      payload:
        type: string

    ChatMessageAdded:
      name: 'chat message added'
      description: Оповещение от сервера о новом сообщении в чате
      payload:
        $ref: '#/components/schemas/ChatMessage'

    MessagesList:
      name: 'messages list'
      description: Событие от сервера со списком сообщений чата
      payload:
        type: array
        items:
          $ref: '#/components/schemas/ChatMessage'

    AddIssue:
      name: 'add issue'
      description: Запрос на добавление новой задачи
      payload:
        $ref: '#/components/schemas/Issue'

    IssueAdded:
      name: 'issue added'
      description: Собщение от сервера о добавленой задаче
      payload:
        $ref: '#/components/schemas/Issue'

    IssuesList:
      name: 'issues list'
      description: Событие от сервера со списком задач
      payload:
        type: array
        items:
          $ref: '#/components/schemas/Issue'

    StartGame:
      name: 'start game'
      description: Запрос на запуск игры с выбранными настройками
      payload:
        $ref: '#/components/schemas/GameSettings'

    GameStarted:
      name: 'game started'
      description: Собщение от сервера о запуске игры с выбранными настройками
      payload:
        $ref: '#/components/schemas/GameSettings'

    CancelGame:
      name: 'cancel game'
      description: Запрос на отмену игры

    GameCanceled:
      name: 'game canceled'
      description: Собщение от сервера об отмене игры

    EndGame:
      name: 'end game'
      description: Запрос на остановку игры

    GameEnded:
      name: 'game ended'
      description: Собщение от сервера о конце игры с результатами оценок
      payload:
        $ref: '#/components/schemas/GameResult'

    StartRound:
      name: 'start round'
      description: Запрос на запуск раунда оценок

    RoundStarted:
      name: 'round started'
      description: Собщение от сервера о запущенном раунде по оценке задачи

    RoundEnded:
      name: 'round ended'
      description: Собщение от сервера о конце раунда, после получения всех оценок или по таймеру
      payload:
        $ref: '#/components/schemas/RoundResult'

    AddScore:
      name: 'add score'
      description: Запрос на выставление задаче оценки из выбранной карты
      payload:
        $ref: '#/components/schemas/Score'
